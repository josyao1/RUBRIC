// Prisma Schema - works with both SQLite (local) and PostgreSQL (production)
// Switch by changing DATABASE_URL in .env

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite" // Change to "postgresql" for production
  url      = env("DATABASE_URL")
}

// ============================================================================
// USERS (for future auth)
// ============================================================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rubrics     Rubric[]
  assignments Assignment[]
}

// ============================================================================
// RUBRICS & CRITERIA
// ============================================================================

model Rubric {
  id          String   @id @default(uuid())
  name        String
  description String?
  sourceFile  String?  // Path to uploaded file
  rawContent  String?  // Extracted text from file
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  criteria    Criterion[]
  assignments Assignment[]
  aiFeedback  RubricFeedback[]
}

// AI-generated feedback on rubric quality
model RubricFeedback {
  id          String   @id @default(uuid())
  feedback    String   // The AI-generated feedback (markdown)
  generatedAt DateTime @default(now())

  rubricId String
  rubric   Rubric @relation(fields: [rubricId], references: [id], onDelete: Cascade)
}

model Criterion {
  id          String  @id @default(uuid())
  name        String
  description String?
  sortOrder   Int     @default(0)

  rubricId String
  rubric   Rubric @relation(fields: [rubricId], references: [id], onDelete: Cascade)

  levels          CriterionLevel[]
  inlineComments  InlineComment[]
  sectionFeedback SectionFeedback[]
}

// Levels within a criterion (e.g., "Excellent", "Good", "Developing", "Beginning")
model CriterionLevel {
  id          String @id @default(uuid())
  label       String // e.g., "Excellent", "Proficient", "Developing", "Beginning"
  description String // What this level looks like
  sortOrder   Int    @default(0) // 0 = highest level

  criterionId String
  criterion   Criterion @relation(fields: [criterionId], references: [id], onDelete: Cascade)
}

// ============================================================================
// ASSIGNMENTS & SUBMISSIONS
// ============================================================================

model Assignment {
  id        String    @id @default(uuid())
  name      String
  dueDate   DateTime?
  createdAt DateTime  @default(now())
  joinCode  String?   @unique

  // Grading pipeline
  gradingStatus      String  @default("idle") // idle, in_progress, completed, error
  gradingProgress    Int     @default(0)      // Number of submissions processed
  gradingTotal       Int     @default(0)      // Total submissions to process
  teacherPreferences String? // Extra instructions for the LLM

  userId   String?
  user     User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  rubricId String?
  rubric   Rubric? @relation(fields: [rubricId], references: [id], onDelete: SetNull)

  submissions Submission[]
}

model Student {
  id        String   @id @default(uuid())
  name      String
  email     String?  // For sending feedback (required to release)
  studentId String?  // External student ID (optional)
  createdAt DateTime @default(now())

  submissions Submission[]
}

model Submission {
  id            String   @id @default(uuid())
  fileName      String
  filePath      String
  extractedText String?
  status        String   @default("pending") // pending, processing, ready, reviewed
  submittedAt   DateTime @default(now())

  // Magic link for student access
  feedbackToken    String?  @unique // Unique token for student to view feedback
  feedbackReleased Boolean  @default(false) // Has feedback been released to student?
  feedbackViewedAt DateTime? // When student first viewed feedback

  // Revision tracking
  parentSubmissionId String?      // If this is a revision, points to the original
  parentSubmission   Submission?  @relation("SubmissionRevisions", fields: [parentSubmissionId], references: [id], onDelete: SetNull)
  revisions          Submission[] @relation("SubmissionRevisions")

  assignmentId String?
  assignment   Assignment? @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  studentId    String?
  student      Student?    @relation(fields: [studentId], references: [id], onDelete: SetNull)

  inlineComments  InlineComment[]
  sectionFeedback SectionFeedback[]
  overallFeedback OverallFeedback?
}

// ============================================================================
// FEEDBACK SYSTEM
// ============================================================================

model InlineComment {
  id              String @id @default(uuid())
  startPosition   Int // Character offset start
  endPosition     Int // Character offset end
  highlightedText String // The actual text being commented on
  comment         String // The feedback

  submissionId String
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  criterionId  String?
  criterion    Criterion? @relation(fields: [criterionId], references: [id], onDelete: SetNull)

  thread CommentThread?
}

model SectionFeedback {
  id             String @id @default(uuid())
  strengths      String // JSON array
  areasForGrowth String // JSON array
  suggestions    String // JSON array

  submissionId String
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  criterionId  String
  criterion    Criterion  @relation(fields: [criterionId], references: [id], onDelete: Cascade)
}

model OverallFeedback {
  id                   String @id @default(uuid())
  summary              String
  priorityImprovements String // JSON array
  encouragement        String?
  nextSteps            String // JSON array

  submissionId String     @unique
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
}

// ============================================================================
// STUDENT CONVERSATION THREADS
// ============================================================================

model CommentThread {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  inlineCommentId String        @unique
  inlineComment   InlineComment @relation(fields: [inlineCommentId], references: [id], onDelete: Cascade)

  messages ThreadMessage[]
}

model ThreadMessage {
  id        String   @id @default(uuid())
  role      String // 'student' or 'assistant'
  content   String
  createdAt DateTime @default(now())

  threadId String
  thread   CommentThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
}
